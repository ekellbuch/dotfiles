########################################
# ~/.bash_common
# Sourced by both mac/.bash_aliases and linux/.bash_aliases
########################################

########################################
# Basics
########################################
realias() { source ~/.bash_aliases; [ -f ~/.secrets/tokens.sh ] && source ~/.secrets/tokens.sh; }

# ls family
alias la='ls -A'
alias l='ls -CF'
alias ll='ls -Flas'
alias c='clear; ls'

# tmux
alias muxi='tmux attach-session -t'

########################################
# Conda
########################################
coda() { conda activate "$@"; }
codi() { conda deactivate; }

########################################
# Utility
########################################
_is_cmd() { command -v "$1" >/dev/null 2>&1; }

open_cmd() {
  if _is_cmd xdg-open; then xdg-open "$@"
  elif _is_cmd open; then open "$@"
  else echo "No opener found (xdg-open/open)."
  fi
}

clipcopy() {
  if _is_cmd pbcopy; then pbcopy
  elif _is_cmd xclip; then xclip -selection clipboard
  else echo "No clipboard tool found (pbcopy/xclip)." >&2; return 1
  fi
}

abspath() {
  if _is_cmd realpath; then realpath "$1"
  else
    python - <<'PY' "$1"
import os, sys
print(os.path.realpath(sys.argv[1]))
PY
  fi
}

ddr() {
  local p
  p="$(abspath "$1")" || return
  printf "%s" "$p" | clipcopy || return
  echo "Copied: $p"
}

copout() {
  abspath "${1:-.}" > ~/.tmpfullpath
  echo "Saved: $(cat ~/.tmpfullpath)"
}

tout() { cat ~/.tmpfullpath; }

########################################
# Navigation
########################################
cd_up()
{
    cd $(printf "%0.s../" $(seq 1 $1));
}
alias 'cd..'='cd_up'

########################################
# Git
########################################
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gd='git diff --color=always'
alias gdc='git diff --cached --color=always'

gcm()  { git commit -m "$*"; }
gcmp() { git commit -m "$*" && git push; }

########################################
# Remote hosts
########################################
SSH_PORT=22
SSH_FLAGS=(-C -Y -X)

HOST_AXON="axon.rc.zi.columbia.edu"
HOST_HABA="habanero.rcs.columbia.edu"
HOST_MOTO="terremoto.rcs.columbia.edu"
HOST_LION="lion.paninski.zi.columbia.edu"
HOST_PANDA="panda.stats.columbia.edu"
HOST_KOALA="koala.paninski.zi.columbia.edu"
HOST_SHER="login.sherlock.stanford.edu"
HOST_TOGE=""

USER_AXON="ekb2154"
USER_PAN="ekellbuch"
USER_SHER="ekb"
USER_TOGE="macs"
SHER_TRANSFER_DIR="/home/groups/swl1/ekb/transfer"

remote_spec() {
  case "$1" in
    lion)  echo "${USER_PAN}@${HOST_LION}" ;;
    panda) echo "${USER_PAN}@${HOST_PANDA}" ;;
    koala) echo "${USER_PAN}@${HOST_KOALA}" ;;
    axon)  echo "${USER_AXON}@${HOST_AXON}" ;;
    haba)  echo "${USER_AXON}@${HOST_HABA}" ;;
    moto)  echo "${USER_AXON}@${HOST_MOTO}" ;;
    sher)  echo "${USER_SHER}@${HOST_SHER}" ;;
    toge)  echo "${USER_TOGE}@${HOST_TOGE}" ;;
    *)
      echo "Unknown remote: $1 (expected: lion|panda|koala|axon|haba|moto|sher|toge)" >&2
      return 1
      ;;
  esac
}

remote_default_dir() {
  case "$1" in
    sher) echo "$SHER_TRANSFER_DIR" ;;
    *)    return 1 ;;
  esac
}

########################################
# SSH / rsync
########################################

logremote() {
  local r; r="$(remote_spec "$1")" || return
  if [[ "$1" == "toge" ]]; then
    ssh -J "$r" "${USER_TOGE}@slurm-login"
  else
    ssh -p "$SSH_PORT" -CYX "$r"
  fi
}

rsync_ssh() {
  rsync -avhP --progress -e "ssh -p $SSH_PORT" "$@"
}

sendremote() {
  local remote="$1"
  local r; r="$(remote_spec "$remote")" || return
  local src="$2"
  local dst="$3"

  [[ -n "$src" ]] || { echo "Usage: sendremote <remote> <local_path> [remote_path]" >&2; return 2; }

  if [[ -z "$dst" ]]; then
    local defdir
    defdir="$(remote_default_dir "$remote")" || {
      echo "No default directory configured for remote '$remote' (pass remote_path explicitly)" >&2
      return 2
    }
    dst="${defdir%/}/$(basename "$src")"
  fi
  rsync_ssh "$src" "${r}:$dst"
}

getremote() {
  local r; r="$(remote_spec "$1")" || return
  local src="$2"
  local dst="${3:-.}"
  if [[ -z "$src" ]]; then
    echo "Usage: getremote <remote> <remote_path> [local_dest]" >&2
    return 2
  fi
  rsync_ssh "${r}:$src" "$dst"
}

tmpremote() {
  local r; r="$(remote_spec "$1")" || return
  ssh -p "$SSH_PORT" "$r" 'cat ~/.tmpfullpath'
}

copremote() {
  local r; r="$(remote_spec "$1")" || return
  local p
  p="$(ssh -p "$SSH_PORT" "$r" 'cat ~/.tmpfullpath')" || return
  p="${p%$'\n'}"
  [[ -n "$p" ]] || { echo "No ~/.tmpfullpath on $1" >&2; return 1; }
  rsync_ssh "${r}:$p" "."
}

########################################
# Jupyter
########################################
jupyinit() {
  local port="${1:-8888}"
  jupyter lab --port="$port" --NotebookApp.iopub_data_rate_limit=1.0e10
}

jupytopy()  { jupyter nbconvert --to script "$1"; }
jupytohtml() { jupyter nbconvert --to html "$1"; echo "${1%.*}.html"; }

jupyview() {
  jupyter nbconvert --to html "$1" || return
  open_cmd "${1%.*}.html"
}

jupytunnel() {
  local r; r="$(remote_spec "$1")" || return
  local lport="${2:-8891}" rport="${3:-8891}"
  echo "Forwarding http://localhost:${lport} -> ${1}:localhost:${rport}"
  ssh -p "$SSH_PORT" -o ForwardX11=Yes -N -f -L "localhost:${lport}:localhost:${rport}" "$r"
}
