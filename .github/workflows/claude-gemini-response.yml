name: Claude Responds to Gemini Code Assist

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  claude-responds-to-gemini:
    # Trigger when Gemini Code Assist posts a code review (issue comment or inline comment)
    if: |
      (
        (github.event_name == 'issue_comment' &&
         github.event.issue.pull_request &&
         github.event.comment.user.login == 'gemini-code-assist[bot]' &&
         !contains(github.event.comment.body, 'will post my feedback shortly'))
        ||
        (github.event_name == 'pull_request_review_comment' &&
         github.event.comment.user.login == 'gemini-code-assist[bot]')
      )

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Get PR details
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            if (context.eventName === 'issue_comment') {
              prNumber = context.issue.number;
            } else {
              prNumber = context.payload.pull_request.number;
            }

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('head_ref', pr.data.head.ref);
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('pr_number', prNumber);
            return pr.data;

      - name: Check iteration count and cooldown
        id: check-iteration
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            if (context.eventName === 'issue_comment') {
              prNumber = context.issue.number;
            } else {
              prNumber = context.payload.pull_request.number;
            }

            // Get PR labels
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const labels = pr.labels.map(l => l.name);

            // Find existing iteration label
            const iterationLabel = labels.find(l => l.startsWith('gemini-claude-iteration-'));
            let currentIteration = 0;

            if (iterationLabel) {
              currentIteration = parseInt(iterationLabel.split('-').pop());
            }

            const maxIterations = 3;

            if (currentIteration >= maxIterations) {
              core.setOutput('should_continue', 'false');
              core.info(`Max iterations (${maxIterations}) reached. Stopping.`);
              return;
            }

            // Check cooldown - look at recent commits
            const commits = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: pr.head.sha,
              per_page: 1
            });

            if (commits.data.length > 0) {
              const lastCommit = commits.data[0];
              const commitDate = new Date(lastCommit.commit.committer.date);
              const now = new Date();
              const diffMinutes = (now - commitDate) / 1000 / 60;

              // 5 minute cooldown after Claude commits
              if (diffMinutes < 5 && lastCommit.commit.message.includes('Address Gemini')) {
                core.setOutput('should_continue', 'false');
                core.info('Cooldown period active. Skipping.');
                return;
              }
            }

            // Update iteration label
            if (iterationLabel) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: iterationLabel
                });
              } catch (e) {
                // Label might not exist, ignore
              }
            }

            const newLabel = `gemini-claude-iteration-${currentIteration + 1}`;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [newLabel]
            });

            core.setOutput('should_continue', 'true');
            core.setOutput('iteration', currentIteration + 1);
            core.setOutput('pr_number', prNumber);

      - name: Checkout repository
        if: steps.check-iteration.outputs.should_continue == 'true'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ steps.pr-details.outputs.head_ref }}

      - name: Run Claude Code
        if: steps.check-iteration.outputs.should_continue == 'true'
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Gemini Code Assist has posted a code review on this PR (iteration ${{ steps.check-iteration.outputs.iteration }} of 3).

            ## Your Task

            1. **Read ALL Gemini Code Assist comments** on PR #${{ steps.check-iteration.outputs.pr_number }}
               - Look for the comment from gemini-code-assist[bot] that contains "Code Review"
               - Also check for any inline review comments from Gemini

            2. **Analyze each suggestion** and decide:
               - AGREE: Improves code quality, fixes bugs, follows project conventions
               - DISAGREE: Would break functionality, contradicts project patterns, or is purely subjective style
               - PARTIAL: Core idea is good but implementation differs

            3. **Post a summary comment** with this format:
               ```
               ## Claude's Response to Gemini Code Assist Review (Iteration ${{ steps.check-iteration.outputs.iteration }}/3)

               | # | Gemini Suggestion | Verdict | Reasoning | Action |
               |---|-------------------|---------|-----------|--------|
               | 1 | [brief description] | Agree/Disagree/Partial | [1-2 sentences] | [Will fix/No action/Modified fix] |
               ```

            4. **Implement changes** only for suggestions you AGREE or PARTIALLY AGREE with

            5. **Commit with message**: "Address Gemini Code Assist suggestions (iteration ${{ steps.check-iteration.outputs.iteration }})"

            ## Stop Conditions
            - If Gemini has no actionable code suggestions: acknowledge briefly, stop
            - If all suggestions are minor style nitpicks you disagree with: explain why, stop
            - If Gemini's comments are already addressed: note this, stop
            - Be decisive - this is iteration ${{ steps.check-iteration.outputs.iteration }} of 3

          claude_args: |
            --max-turns 15
            --allowedTools "WebFetch,Bash(uv sync --dev),Bash(uv run ruff *),Bash(uv run pytest *),Bash(uv run python *)"
            --system-prompt "Python trace analysis project using uv for package management. Follow ruff lint rules in pyproject.toml. Run tests before completing implementation tasks. Use Python 3.13+ features.

            When responding to Gemini Code Assist reviews:
            - Be diplomatic but firm in technical assessments
            - Cite specific technical reasons for disagreements
            - Prioritize working code over style preferences
            - Always run tests before committing changes
            - Use markdown tables for clarity in summary comments
            - If uncertain about a suggestion, lean toward implementing it"
